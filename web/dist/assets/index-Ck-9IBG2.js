import{r as l,j as e,I as E,m as q}from"./index-CJKIoR4P.js";import{E as z}from"./index-BeTriTPE.js";import{a as P,b as Q}from"./graphql-BMQ1_SbA.js";const M=()=>{const[f,T]=l.useState(0),[c,b]=l.useState([0,0]),[d,D]=l.useState({}),{data:i,loading:p,error:y,refetch:k}=P({pollInterval:60*1e3});l.useEffect(()=>{!p&&!y&&i&&(T(i.getCurrentTime.timestamp),b([i.getCurrentTime.timestamp-1440*60*1e3,i.getCurrentTime.timestamp]),D(i.getObserveNTPServerList.reduce((s,{name:t,address:r,remark:a,createdAt:m,updatedAt:o,uuid:n})=>({...s,[n]:{name:t,address:r,remark:a,createdAt:m,updatedAt:o}}),{})))},[i,y,p]);const j=l.useRef({}),[N,{loading:R}]=Q(),[h,C]=l.useState({}),[x,S]=l.useState([]),u=l.useCallback(async(s,t,r)=>{const{data:a}=await N({variables:{uuid:r,start:s,end:t}});a&&C(m=>({...m,[r]:a.getServerOffsets.map(o=>({...o,name:d[r].name,address:d[r].address}))}))},[N,d]),v=l.useCallback(async(s,t)=>{for(const r of x)await u(s,t,r)},[u,x]),$=l.useMemo(()=>[{label:"10 min",ms:600*1e3},{label:"30 min",ms:1800*1e3},{label:"60 min",ms:3600*1e3},{label:"6 hours",ms:360*60*1e3},{label:"12 hours",ms:720*60*1e3},{label:"24 hours",ms:1440*60*1e3}],[]),g=l.useRef(null),L=l.useCallback(async()=>{var r,a;const s=new Date(((r=g.current)==null?void 0:r.value)??0).getTime(),t=s+1440*60*1e3;if(!s){(a=g.current)==null||a.focus();return}b([s,t]),v(s,t)},[v]),w=s=>s?new Intl.DateTimeFormat("en-US",{timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(new Date(s)):"",I=l.useCallback(s=>{const t=h[s];if(!t)return{};const r=o=>{const n=o.data[2];return`<div style="font-size:13px;">
            <b>${new Date(n.timestamp).toLocaleString("en-US")}</b>
            <br/><br/>

            <b>Name:</b> ${n.name}<br/>
            <b>Address:</b> ${n.address}<br/>
            <b>Time Offset:</b> ${n.offset} ms<br/>
            <b>Round Trip:</b> ${n.roundTrip} ms<br/>
            <b>Root Delay:</b> ${n.rootDelay} ms<br/>
            <b>Root Dispersion:</b> ${n.rootDispersion} ms<br/>
            <b>Root Distance:</b> ${n.rootDistance} ms<br/>
            <b>Stratum:</b> ${n.stratum}<br/>
            <b>Server Reference ID:</b> ${n.serverRefId}<br/>
            <b>Reference Server:</b> ${n.reference}<br/>
        </div>`},a=o=>{const n=new Date(o),O=n.getHours().toString().padStart(2,"0"),A=n.getMinutes().toString().padStart(2,"0");return`${O}:${A}`};return{tooltip:{trigger:"item",formatter:r},yAxis:{type:"value",name:"Drift (ppm)"},dataZoom:[{type:"inside",throttle:50}],series:[{type:"scatter",symbolSize:8,data:t.map(o=>[o.timestamp,o.offset,o])}],xAxis:{type:"time",axisLabel:{formatter:a,hideOverlap:!0,interval:"auto",rotate:0}}}},[h]);return(i==null?void 0:i.getObserveNTPServerList)!==void 0?e.jsxs("div",{className:"ml-4 flex flex-col space-y-4 md:mt-6",children:[e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx("h2",{className:"mb-2 text-4xl font-extrabold text-gray-800",children:"Server Offsets Visualization"}),c[0]!==0&&c[1]!==0&&e.jsxs("span",{className:"font-mono text-gray-700",children:["Displaying data from",e.jsxs("b",{children:[" ",w(c[0])," "]}),"to",e.jsxs("b",{children:[" ",w(c[1])]}),"."]}),c[0]!==0&&c[1]!==0&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{className:"btn btn-sm",onClick:()=>k(),children:[e.jsx(E,{path:q,size:.85,className:"opacity-80"}),e.jsx("span",{children:"Refresh"})]}),$.map(({label:s,ms:t})=>e.jsx("button",{className:"btn btn-sm",onClick:()=>{b([f-t,f]),v(f-t,f)},children:s},s))]}),c[0]!==0&&c[1]!==0&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{required:!0,ref:g,type:"date",className:"input input-sm font-mono text-sm outline-0"}),e.jsx("button",{onClick:L,className:"btn btn-sm",children:"Search"})]})]}),e.jsxs("div",{className:"flex flex-col space-x-4 md:flex-row",children:[e.jsx("div",{className:"flex flex-1 flex-col space-y-4 p-2 md:w-1/2",children:e.jsx("div",{className:"card card-border bg-base-100 w-full rounded-md shadow-md",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h2",{className:"card-title",children:"Select Servers"}),e.jsx("div",{className:"mt-4 max-h-screen overflow-scroll",children:Object.entries(d).sort((s,t)=>s[1].createdAt-t[1].createdAt).map(([s,t])=>e.jsxs("label",{className:"flex min-w-xs cursor-pointer items-center space-x-6 rounded p-2 hover:bg-gray-100",children:[e.jsx("input",{type:"checkbox",className:"checkbox checkbox-sm mt-1",checked:x.includes(s),onChange:r=>{r.target.checked?(S(a=>[...a,s]),u(c[0],c[1],s)):S(a=>a.filter(m=>m!==s))}}),e.jsxs("div",{className:"flex w-full flex-col text-sm leading-tight text-gray-700",children:[e.jsx("span",{className:"font-medium",children:t.name}),e.jsx("span",{className:"text-gray-500",children:t.remark}),e.jsx("span",{className:"text-gray-600",children:t.address})]}),x.includes(s)&&e.jsx("button",{className:"btn btn-xs justify-center text-center",onClick:()=>{const r=j.current[s];r&&r.scrollIntoView({behavior:"smooth",block:"start"})},children:"Go"})]},s))})]})})}),e.jsx("div",{className:"animate-fade-down animate-delay-500 p-2 md:w-2/3",children:e.jsx("div",{className:"h-full overflow-y-auto rounded-lg",children:e.jsx("div",{className:"flex flex-col space-y-4",children:x.map(s=>{var t,r,a;return e.jsxs("div",{className:"flex h-[500px] w-full flex-col items-center justify-center rounded-md border-2 border-gray-100 p-2",ref:m=>{j.current[s]=m},children:[e.jsxs("h2",{className:"text-md mt-4 text-center",children:[e.jsx("span",{className:"font-bold text-gray-700",children:(t=d[s])==null?void 0:t.name}),e.jsx("br",{}),e.jsx("span",{className:"text-gray-600",children:(r=d[s])==null?void 0:r.address})]}),R?e.jsx("span",{className:"loading loading-spinner loading-xl m-auto text-gray-500"}):((a=h[s])==null?void 0:a.length)>0?e.jsx(z,{option:I(s),style:{height:"100%",width:"100%"}}):e.jsx("span",{className:"m-auto text-sm text-gray-600",children:"No data"})]},s)})})})})]})]}):e.jsx("div",{className:"flex h-full w-full justify-center",children:p?e.jsx("span",{className:"loading loading-spinner loading-xl m-auto text-gray-500"}):e.jsx("span",{className:"my-auto text-xl font-bold text-gray-700",children:"Please add some obervation NTP servers first."})})};export{M as default};
