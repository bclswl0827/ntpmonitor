import{r as l,j as e,I as A,m as q}from"./index-Dv0UX_5y.js";import{E as z}from"./index-D4dGeu3Q.js";import{a as P,b as Q}from"./graphql-Dj-Mxtq8.js";const M=()=>{const[b,D]=l.useState(0),[o,p]=l.useState([0,0]),y=l.useRef({}),[j,{loading:k}]=P(),[x,N]=l.useState({}),[m,S]=l.useState([]),[d,C]=l.useState({}),{data:i,loading:h,error:O,refetch:R}=Q({pollInterval:60*1e3});l.useEffect(()=>{!h&&!O&&i&&(D(i.getCurrentTime.timestamp),p([i.getCurrentTime.timestamp-1440*60*1e3,i.getCurrentTime.timestamp]),C(i.getObserveNTPServerList.reduce((s,{name:t,address:r,remark:a,createdAt:f,updatedAt:c,uuid:n})=>({...s,[n]:{name:t,address:r,remark:a,createdAt:f,updatedAt:c}}),{})))},[i,O,h]),l.useEffect(()=>{for(const s of Object.keys(x))if(!d[s]){const t={...x};delete t[s],N(t),m.splice(m.indexOf(s),1)}},[d,m,x]);const u=l.useCallback(async(s,t,r)=>{try{const{data:a}=await j({variables:{uuid:r,start:s,end:t}});a&&N(f=>({...f,[r]:a.getServerOffsets.map(c=>({...c,name:d[r].name,address:d[r].address}))}))}catch{}},[j,d]),g=l.useCallback(async(s,t)=>{try{for(const r of m)await u(s,t,r)}catch{}},[u,m]),$=l.useMemo(()=>[{label:"10 min",ms:600*1e3},{label:"30 min",ms:1800*1e3},{label:"60 min",ms:3600*1e3},{label:"6 hours",ms:360*60*1e3},{label:"12 hours",ms:720*60*1e3},{label:"24 hours",ms:1440*60*1e3},{label:"48 hours",ms:2880*60*1e3},{label:"72 hours",ms:4320*60*1e3}],[]),v=l.useRef(null),L=l.useCallback(async()=>{var r,a;const s=new Date(((r=v.current)==null?void 0:r.value)??0).getTime(),t=s+1440*60*1e3;if(!s){(a=v.current)==null||a.focus();return}p([s,t]),g(s,t)},[g]),w=s=>s?new Intl.DateTimeFormat("en-US",{timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(new Date(s)):"",I=l.useCallback(s=>{const t=x[s];if(!t)return{};const r=c=>{const n=c.data[2];return`<div style="font-size:13px;">
            <b>${new Date(n.timestamp).toLocaleString("en-US")}</b>
            <br/><br/>

            <b>Name:</b> ${n.name}<br/>
            <b>Address:</b> ${n.address}<br/>
            <b>Time Offset:</b> ${n.offset} ms<br/>
            <b>Stratum:</b> ${n.stratum}<br/>
            <b>Round Trip:</b> ${n.roundTrip} ms<br/>
            <b>Root Distance:</b> ${n.rootDistance} ms<br/>
            <b>Root Delay:</b> ${n.rootDelay} ms<br/>
            <b>Root Dispersion:</b> ${n.rootDispersion} ms<br/>
            <b>Server Reference ID:</b> ${n.serverRefId}<br/>
            <b>Compared with:</b> ${n.reference}<br/>
        </div>`},a=c=>{const n=new Date(c),T=n.getHours().toString().padStart(2,"0"),E=n.getMinutes().toString().padStart(2,"0");return`${T}:${E}`};return{tooltip:{trigger:"item",formatter:r},yAxis:{type:"value",name:"Offset (ms)"},dataZoom:[{type:"inside",throttle:50}],series:[{type:"scatter",symbolSize:8,data:t.map(c=>[c.timestamp,c.offset,c])}],xAxis:{type:"time",axisLabel:{formatter:a,hideOverlap:!0,interval:"auto",rotate:0}}}},[x]);return e.jsxs("div",{className:"mx-4 flex flex-col space-y-4 md:mt-6",children:[e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx("h2",{className:"mb-2 text-4xl font-extrabold text-gray-800",children:"Server Offsets Visualization"}),o[0]!==0&&o[1]!==0&&e.jsxs("span",{className:"font-mono text-gray-700",children:["Displaying data from",e.jsxs("b",{children:[" ",w(o[0])," "]}),"to",e.jsxs("b",{children:[" ",w(o[1])]}),"."]}),o[0]!==0&&o[1]!==0&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{className:"btn btn-sm",onClick:()=>R(),children:[e.jsx(A,{path:q,size:.85,className:"opacity-80"}),e.jsx("span",{children:"Refresh"})]}),$.map(({label:s,ms:t})=>e.jsx("button",{className:"btn btn-sm",onClick:()=>{p([b-t,b]),g(b-t,b)},children:s},s))]}),o[0]!==0&&o[1]!==0&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{required:!0,ref:v,type:"date",className:"input input-sm font-mono text-sm outline-0"}),e.jsx("button",{onClick:L,className:"btn btn-sm",children:"Search"})]})]}),(i==null?void 0:i.getObserveNTPServerList)!==void 0?e.jsxs("div",{className:"flex flex-col space-x-4 md:flex-row",children:[e.jsx("div",{className:"flex flex-1 flex-col space-y-4 p-2 md:w-1/2",children:e.jsx("div",{className:"card card-border bg-base-100 w-full rounded-md shadow-md",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h2",{className:"card-title",children:"Select Servers"}),e.jsx("div",{className:"mt-4 max-h-screen overflow-scroll",children:Object.entries(d).sort((s,t)=>t[1].createdAt-s[1].createdAt).map(([s,t])=>e.jsxs("label",{className:"flex min-w-xs cursor-pointer items-center space-x-6 rounded p-2 hover:bg-gray-100",children:[e.jsx("input",{type:"checkbox",className:"checkbox checkbox-sm mt-1",checked:m.includes(s),onChange:r=>{r.target.checked?(S(a=>(a.unshift(s),a)),u(o[0],o[1],s)):S(a=>a.filter(f=>f!==s))}}),e.jsxs("div",{className:"flex w-full flex-col text-sm leading-tight text-gray-700",children:[e.jsx("span",{className:"font-medium",children:t.name}),e.jsx("span",{className:"text-gray-500",children:t.remark}),e.jsx("span",{className:"text-gray-600",children:t.address})]}),m.includes(s)&&e.jsx("button",{className:"btn btn-xs justify-center text-center",onClick:()=>{const r=y.current[s];r&&r.scrollIntoView({behavior:"smooth",block:"start"})},children:"Go"})]},s))})]})})}),e.jsx("div",{className:"animate-fade-down animate-delay-500 p-2 md:w-2/3",children:e.jsx("div",{className:"h-full overflow-y-auto rounded-lg",children:e.jsx("div",{className:"flex flex-col space-y-4",children:m.map(s=>{var t,r,a;return e.jsxs("div",{className:"flex h-[500px] w-full flex-col items-center justify-center rounded-md border-2 border-gray-100 p-2",ref:f=>{y.current[s]=f},children:[e.jsxs("h2",{className:"text-md mt-4 text-center",children:[e.jsx("span",{className:"font-bold text-gray-700",children:(t=d[s])==null?void 0:t.name}),e.jsx("br",{}),e.jsx("span",{className:"text-gray-600",children:(r=d[s])==null?void 0:r.address})]}),k?e.jsx("span",{className:"loading loading-spinner loading-xl m-auto text-gray-500"}):((a=x[s])==null?void 0:a.length)>0?e.jsx(z,{option:I(s),style:{height:"100%",width:"100%"}}):e.jsx("span",{className:"m-auto text-sm text-gray-600",children:"No data"})]},s)})})})})]}):e.jsx("div",{className:"flex h-64 w-full items-center justify-center",children:h?e.jsx("span",{className:"loading loading-spinner loading-xl text-gray-500"}):e.jsx("span",{className:"text-xl font-bold text-gray-700",children:"Please add some observation NTP servers first."})})]})};export{M as default};
